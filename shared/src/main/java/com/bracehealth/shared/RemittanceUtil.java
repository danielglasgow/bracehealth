package com.bracehealth.shared;

import java.util.Random;
import com.bracehealth.shared.CurrencyUtil.CurrencyAmount;

/**
 * Helper for generating remittances.
 * 
 * Normally remittances would be generated by a real (third-party) clearinghouse. This class
 * provides helpers for generating remittances for testing / simulation purposes.
 **/
public class RemittanceUtil {
    private static final Random random = new Random();

    private RemittanceUtil() {}


    public static Remittance generateRandomRemittance(PayerClaim claim) {
        CurrencyAmount totalAmountOwed = CurrencyAmount.ZERO;
        for (ServiceLine serviceLine : claim.getServiceLinesList()) {
            totalAmountOwed =
                    totalAmountOwed.add(CurrencyAmount.fromProto(serviceLine.getCharge()));
        }
        CurrencyAmount remainingAmountOwed = totalAmountOwed;
        CurrencyAmount payerPaidAmount = CurrencyAmount.ZERO;
        CurrencyAmount coinsuranceAmount = CurrencyAmount.ZERO;
        CurrencyAmount copayAmount = CurrencyAmount.ZERO;
        CurrencyAmount deductibleAmount = CurrencyAmount.ZERO;
        CurrencyAmount notAllowedAmount = CurrencyAmount.ZERO;
        while (remainingAmountOwed.isGreaterThanOrEqualTo(CurrencyAmount.ONE)) {
            CurrencyAmount amount = remainingAmountOwed.subtract(CurrencyAmount.ONE);
            int randomIndex = random.nextInt(5);
            switch (randomIndex) {
                case 0 -> payerPaidAmount = payerPaidAmount.add(amount);
                case 1 -> coinsuranceAmount = coinsuranceAmount.add(amount);
                case 2 -> copayAmount = copayAmount.add(amount);
                case 3 -> deductibleAmount = deductibleAmount.add(amount);
                case 4 -> notAllowedAmount = notAllowedAmount.add(amount);
                default -> throw new IllegalStateException("Unexpected value: " + randomIndex);
            }
        }
        int deductedCents = 0;
        if (payerPaidAmount.isGreaterThan(CurrencyAmount.ONE)) {
            int randomDeductedCents = random.nextInt(100);
            deductedCents += randomDeductedCents;
            payerPaidAmount = payerPaidAmount.subtractDecimal(deductedCents);
        }
        if (coinsuranceAmount.isGreaterThan(CurrencyAmount.ONE)) {
            int randomDeductedCents = random.nextInt(100);
            deductedCents += randomDeductedCents;
            coinsuranceAmount = coinsuranceAmount.subtractDecimal(deductedCents);
        }
        if (copayAmount.isGreaterThan(CurrencyAmount.ONE)) {
            int randomDeductedCents = random.nextInt(100);
            deductedCents += randomDeductedCents;
            copayAmount = copayAmount.subtractDecimal(deductedCents);
        }
        if (deductibleAmount.isGreaterThan(CurrencyAmount.ONE)) {
            int randomDeductedCents = random.nextInt(100);
            deductedCents += randomDeductedCents;
            deductibleAmount = deductibleAmount.subtractDecimal(deductedCents);
        }
        if (notAllowedAmount.isGreaterThan(CurrencyAmount.ONE)) {
            int randomDeductedCents = random.nextInt(100);
            deductedCents += randomDeductedCents;
            notAllowedAmount = notAllowedAmount.subtractDecimal(deductedCents);
        }
        remainingAmountOwed = remainingAmountOwed.addDecimal(deductedCents);
        int randomIndex = random.nextInt(5);
        switch (randomIndex) {
            case 0 -> payerPaidAmount = payerPaidAmount.add(totalAmountOwed);
            case 1 -> coinsuranceAmount = coinsuranceAmount.add(totalAmountOwed);
            case 2 -> copayAmount = copayAmount.add(totalAmountOwed);
            case 3 -> deductibleAmount = deductibleAmount.add(totalAmountOwed);
            case 4 -> notAllowedAmount = notAllowedAmount.add(totalAmountOwed);
            default -> throw new IllegalStateException("Unexpected value: " + randomIndex);
        }
        Remittance remittance = Remittance.newBuilder().setClaimId(claim.getClaimId())
                .setPayerPaidAmount(payerPaidAmount.toProto())
                .setCoinsuranceAmount(coinsuranceAmount.toProto())
                .setCopayAmount(copayAmount.toProto())
                .setDeductibleAmount(deductibleAmount.toProto())
                .setNotAllowedAmount(notAllowedAmount.toProto()).build();
        checkState(getTotal(remittance).isEqualTo(totalAmountOwed));
        return remittance;
    }

    private static CurrencyAmount getTotal(Remittance remittance) {
        return CurrencyAmount.fromProto(remittance.getPayerPaidAmount())
                .add(CurrencyAmount.fromProto(remittance.getCoinsuranceAmount()))
                .add(CurrencyAmount.fromProto(remittance.getCopayAmount()))
                .add(CurrencyAmount.fromProto(remittance.getDeductibleAmount()))
                .add(CurrencyAmount.fromProto(remittance.getNotAllowedAmount()));
    }

    private static void checkState(boolean condition) {
        if (!condition) {
            throw new IllegalStateException("Condition is not true");
        }
    }

}
